<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landmark Explorer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f0f0;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #landingPage {
            text-align: center;
        }
        #startButton {
            font-size: 18px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #explorerPage {
            display: none;
            width: 100%;
            max-width: 800px;
        }
        #videoContainer {
            position: relative;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
        }
        #arOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #facts {
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        #nearbyLandmarks {
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        h2 {
            margin-top: 0;
        }
        ul {
            padding-left: 20px;
        }
        #nearbyList {
            padding-left: 20px;
        }
        #navbar {
            display: flex;
            justify-content: space-around;
            background-color: #333;
            padding: 10px 0;
        }
        #navbar a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
        }
        #statusMessage {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }
        #locationDisplay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="landingPage">
            <h1>Welcome to Landmark Explorer</h1>
            <p>Discover landmarks around you in real-time!</p>
            <button id="startButton">Start Exploring</button>
        </div>
        <div id="explorerPage">
            <div id="videoContainer">
                <video id="videoFeed" autoplay playsinline muted></video>
                <canvas id="arOverlay"></canvas>
                <div id="statusMessage">Initializing...</div>
                <div id="locationDisplay">Location: Unavailable</div>
            </div>
            <div id="facts">
                <h2>Landmark Facts</h2>
                <p id="landmarkName"></p>
                <ul id="factsList"></ul>
            </div>
            <div id="nearbyLandmarks">
                <h2>Nearby Landmarks</h2>
                <ul id="nearbyList"></ul>
            </div>
        </div>
    </div>
    <div id="navbar">
        <a href="#home">Home</a>
        <a href="#recent">Recent Locations</a>
        <a href="#settings">Settings</a>
    </div>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4Xo27wNyl5vJXm32137rlFa4VAcc7JJ4&libraries=places&callback=initMap"></script>
    <script>
        const landingPage = document.getElementById('landingPage');
        const explorerPage = document.getElementById('explorerPage');
        const startButton = document.getElementById('startButton');
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('arOverlay');
        const ctx = canvas.getContext('2d');
        const landmarkName = document.getElementById('landmarkName');
        const factsList = document.getElementById('factsList');
        const statusMessage = document.getElementById('statusMessage');
        const locationDisplay = document.getElementById('locationDisplay');
        
        let lastDetectedLandmarks = [];
        let isProcessing = false;

        function initMap() {
            console.log('Google Maps API loaded');
            // You can initialize any map-related functionality here
        }

        startButton.addEventListener('click', () => {
            console.log('Start button clicked');
            landingPage.style.display = 'none';
            explorerPage.style.display = 'block';
            startExplorer();
        });

        async function startExplorer() {
            console.log('startExplorer function called');
            try {
                console.log('Starting explorer...');
                await startCamera();
                console.log('Camera started successfully');
                
                if ("geolocation" in navigator) {
                    console.log('Geolocation is available');
                    navigator.geolocation.watchPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            locationDisplay.textContent = `Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                            console.log('Geolocation updated:', latitude, longitude);
                        },
                        error => {
                            console.warn("Geolocation error:", error);
                            locationDisplay.textContent = "Location: Unavailable";
                        },
                        { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                    );
                } else {
                    locationDisplay.textContent = "Location: Unsupported";
                    console.log('Geolocation not supported');
                }
                
                console.log('Starting frame processing');
                processFrame();
            } catch (error) {
                console.error('Error starting explorer:', error);
                statusMessage.textContent = 'Error: Unable to start explorer';
            }
        }

        async function startCamera() {
            console.log('startCamera function called');
            try {
                console.log('Attempting to start camera...');
                const constraints = {
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 } 
                    }
                };
                
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    constraints.video.facingMode = { exact: "environment" };
                }

                console.log('Requesting media stream...');
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('Media stream obtained');
                video.srcObject = stream;

                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log('Video metadata loaded');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        statusMessage.textContent = 'Camera ready. Detecting landmarks...';
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('Error accessing camera:', error);
                statusMessage.textContent = 'Error: Unable to access camera';
                throw error;
            }
        }

        function getUserLocation() {
            console.log('getUserLocation function called');
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            locationDisplay.textContent = `Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                            console.log('Location obtained:', latitude, longitude);
                            resolve(position.coords);
                        },
                        error => {
                            console.warn("Geolocation error:", error);
                            locationDisplay.textContent = "Location: Unavailable";
                            reject(error);
                        }
                    );
                } else {
                    console.log('Geolocation not supported');
                    locationDisplay.textContent = "Location: Unsupported";
                    reject(new Error("Geolocation is not supported by this browser."));
                }
            });
        }

        async function captureFrame() {
            console.log('captureFrame function called');
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0);
            console.log('Frame captured');
            return tempCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }

        async function detectLandmark(imageData, latitude, longitude) {
            console.log('detectLandmark function called');
            const apiUrl = `https://vision.googleapis.com/v1/images:annotate?key=AIzaSyA4Xo27wNyl5vJXm32137rlFa4VAcc7JJ4`;
            const requestBody = {
                requests: [{
                    image: { content: imageData },
                    features: [{ type: 'LANDMARK_DETECTION', maxResults: 5 }],
                    imageContext: {
                        latLongRect: {
                            minLatLng: { latitude: latitude - 0.1, longitude: longitude - 0.1 },
                            maxLatLng: { latitude: latitude + 0.1, longitude: longitude + 0.1 }
                        }
                    }
                }]
            };

            try {
                console.log('Sending request to Google Vision API');
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed: ${response.status} ${response.statusText}. ${errorText}`);
                }

                const data = await response.json();
                console.log('Landmark detection response received:', data);
                return data.responses[0].landmarkAnnotations || [];
            } catch (error) {
                console.error('Error in detectLandmark:', error);
                throw new Error(`Failed to fetch data from Google Vision API: ${error.message}`);
            }
        }

        async function fetchLandmarkFacts(landmarkName) {
            console.log('fetchLandmarkFacts function called for:', landmarkName);
            const apiUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=false&explaintext=true&titles=${encodeURIComponent(landmarkName)}&origin=*`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch landmark information');
                }

                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const page = pages[pageId];

                console.log('Landmark facts fetched successfully');
                return page.extract ? page.extract : 'No description available.';
            } catch (error) {
                console.error('Error fetching landmark facts:', error);
                return 'Failed to fetch landmark information.';
            }
        }

        async function getTicketInfo(landmarkName) {
            console.log('getTicketInfo function called for:', landmarkName);
            // In a real application, this would query a ticket API or database
            // For now, we'll return a mock result for demonstration purposes
            return new Promise(resolve => setTimeout(() => {
                if (Math.random() > 0.5) {
                    console.log('Ticket information available');
                    resolve({
                        available: true,
                        url: `https://example.com/tickets/${encodeURIComponent(landmarkName)}`
                    });
                } else {
                    console.log('No ticket information available');
                    resolve({ available: false });
                }
            }, 500));
        }

        async function displayFacts(name, facts) {
            console.log('displayFacts function called for:', name);
            landmarkName.textContent = name || "No landmark detected";
            factsList.innerHTML = '';
            
            if (facts) {
                const sentences = facts.split('. ').filter(s => s.trim().length > 0);
                const topFacts = sentences.slice(0, 5).map(s => s.trim() + (s.endsWith('.') ? '' : '.'));

                topFacts.forEach(fact => {
                    const li = document.createElement('li');
                    li.textContent = fact;
                    factsList.appendChild(li);
                });

                // Add ticket information
                const ticketInfo = await getTicketInfo(name);
                if (ticketInfo.available) {
                    const ticketLi = document.createElement('li');
                    const ticketLink = document.createElement('a');
                    ticketLink.href = ticketInfo.url;
                    ticketLink.target = '_blank';
                    ticketLink.textContent = 'Buy tickets';
                    ticketLi.appendChild(document.createTextNode('Tickets available: '));
                    ticketLi.appendChild(ticketLink);
                    factsList.appendChild(ticketLi);
                }
            }
            console.log('Facts displayed');
        }

        function drawAROverlay(landmarks) {
            console.log('drawAROverlay function called');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            landmarks.forEach((landmark, index) => {
                const { description, locations } = landmark;
                const location = locations[0];

                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 50 * index, canvas.width, 50);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.fillText(description, 10, 35 + 50 * index);
                if (location) {
                    ctx.fillText(`Lat: ${location.latitude.toFixed(4)}, Lng: ${location.longitude.toFixed(4)}`, 10, 70
